<!doctype html><meta charset="utf-8">
<h3>AI WS Test</h3>
<input id="user" value="7" placeholder="memberId">
<button onclick="connect()">Connect</button>
<br><br>
<input id="msg" placeholder="message" onkeydown="if(event.key==='Enter')send()">
<button onclick="send()">Send</button>
<ul id="log"></ul>

<script>
  let ws;
  function log(x){ const li=document.createElement('li'); li.textContent=x; document.getElementById('log').appendChild(li); }

  function connect(){
    const userId = document.getElementById('user').value;
    ws = new WebSocket(`ws://${location.host}/ws-ai?userId=${encodeURIComponent(userId)}`);
    ws.onopen    = () => log('OPEN');
    ws.onclose   = () => log('CLOSE');
    ws.onerror   = (e) => log('ERROR ' + e.message);
    ws.onmessage = (e) => log('RECV ' + e.data);
  }

  function send(){
    if(!ws || ws.readyState !== 1) return;
    const content = document.getElementById('msg').value;
    ws.send(JSON.stringify({
      type: 'USER_MSG',
      clientMessageId: self.crypto?.randomUUID?.() ?? String(Date.now()),
      content
    }));
    document.getElementById('msg').value='';
  }
</script>