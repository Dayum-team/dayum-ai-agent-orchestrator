<!doctype html>
<meta charset="utf-8">
<title>WS Test</title>
<button id="sendText">Send Text</button>
<button id="sendFile">Send File</button>
<pre id="log"></pre>
<script>
  const log = (...a)=>document.getElementById('log').textContent += a.join(' ') + '\n';

  // 포트/경로 맞게 수정
  const ws = new WebSocket("ws://localhost:8081/ws/ai?memberId=1");

  ws.onopen   = () => { log("OPEN"); ws.send(JSON.stringify({event:"connection"})); };
  ws.onmessage= (e) => log("RECV:", e.data);
  ws.onerror  = (e) => log("ERR:", e.message || e.type || e);
  ws.onclose  = (e) => log("CLOSE:", e.code, e.reason);

  // 텍스트 전송
  document.getElementById('sendText').onclick = () => {
    ws.send(JSON.stringify({event:"sendMessage", content:"안녕!", clientMessageId:"c-"+Date.now()}));
  };

  // 파일 전송(청크)
  document.getElementById('sendFile').onclick = async () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = () => sendFile(ws, input.files[0]);
    input.click();
  };

  async function sendFile(ws, file) {
    const CHUNK = 256*1024;

    const base64 = await new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result.split(",")[1]);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });

    // 해시 계산용 원바이트
    const raw = atob(base64);
    const buf = new Uint8Array(raw.length);
    for (let i=0; i<raw.length; i++) buf[i] = raw.charCodeAt(i);
    const shaBuf = await crypto.subtle.digest("SHA-256", buf);
    const sha = Array.from(new Uint8Array(shaBuf)).map(b=>b.toString(16).padStart(2,"0")).join("");

    const totalChunks = Math.ceil(base64.length / CHUNK);
    const uploadId = "u-" + Date.now();

    ws.send(JSON.stringify({
      event: "sendFileStart",
      uploadId,
      filename: file.name,
      mimeType: file.type || "application/octet-stream",
      size: buf.length,
      totalChunks,
      sha256: sha
    }));

    for (let i=0; i<totalChunks; i++) {
      const part = base64.slice(i*CHUNK, (i+1)*CHUNK);
      ws.send(JSON.stringify({ event:"sendFileChunk", uploadId, chunkIndex:i, dataBase64: part }));
    }

    ws.send(JSON.stringify({ event:"sendFileEnd", uploadId }));
    log("FILE SENT:", file.name);
  }
</script>
